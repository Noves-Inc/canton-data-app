[SERVICE]
    Flush        1
    Daemon       Off
    Log_Level    info
    Parsers_File /fluent-bit/etc/parsers.conf

# Tail Docker json-file logs from all containers
[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Tag               docker.*
    Parser            docker
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   Off
    DB                /var/lib/fluent-bit/flb_compose.db
    DB.Sync           Normal
    Refresh_Interval  5

# Parse inner JSON from Docker 'log' field into top-level keys
[FILTER]
    Name          parser
    Match         docker.*
    Key_Name      log
    Parser        json
    Reserve_Data  Off

# Keep only traffic analysis lines (case insensitive)
[FILTER]
    Name    grep
    Match   docker.*
    Regex   message  (?i)(TrafficReceipt\(|EventCostDetails\(|messageId=|message id\s*=\s*Some\(|Sending message ID|updateId=|\bupdateId\b|workflowId=|workflowId\b|commandId\b|Finalizing Transaction request|Phase 7|Responding with update trees|Responding with updates|EventPublicationTask\(|SequencedCommandRejected|SequencedTransactionAccepted|Processing event|CommandService/SubmitAndWait|CommandService/Submit)

# Send to Data App backend via HTTP
[OUTPUT]
    Name              http
    Match             docker.*
    Host              canton-data-app-backend
    Port              5124
    URI               /ingest
    Format            json_lines
    Json_date_key     timestamp
    Json_date_format  iso8601
    Retry_Limit       5
